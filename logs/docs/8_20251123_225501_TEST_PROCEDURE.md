# KiDoom macOS Crash Fix - Testing Procedure

## Quick Test (5 minutes)

### Prerequisites
1. **Quit KiCad** completely (Cmd+Q, ensure no processes remain)
2. **Ensure DOOM binary exists**:
   ```bash
   ls -lh ~/Desktop/KiDoom/doom/doomgeneric_kicad
   ```
   Should show the compiled binary (not found = need to compile first)

### Test Steps

1. **Launch KiCad PCBnew**
   ```bash
   open -a KiCad
   # Wait for KiCad to fully load
   ```

2. **Create or Open a PCB**
   - File ‚Üí New Project ‚Üí Blank PCB
   - Or open existing: `kicad_source/blank_project/blank_project.kicad_pcb`

3. **Run the Plugin**
   - Tools ‚Üí External Plugins ‚Üí "KiDoom - DOOM on PCB"
   - **Watch console** for startup messages
   - **Expected**: No crash, DOOM window appears

4. **Verify Rendering**
   - Wait for DOOM to fully load (~5-10 seconds)
   - **Look at PCB editor window** - you should see traces appearing
   - Press **Enter** to start game
   - Press **WASD** to move around
   - **Expected**: PCB traces animate as you move

5. **Check for Crashes**
   - Play for **30 seconds**
   - Move, turn, shoot (Ctrl key)
   - **Expected**: No crashes, smooth(ish) animation

6. **Clean Shutdown**
   - Press **ESC** to open menu
   - Press **ESC** again to quit DOOM
   - **Expected**: DOOM closes, KiCad remains stable

### Success Criteria

‚úÖ KiCad does NOT crash when launching plugin
‚úÖ DOOM process starts (check console for PID)
‚úÖ PCB traces appear and animate
‚úÖ Clean shutdown without errors

### Failure Indicators

‚ùå KiCad crashes immediately when clicking plugin
‚ùå Error: "DOOM binary not found"
‚ùå DOOM window opens but no PCB traces
‚ùå KiCad hangs/freezes

## Detailed Test (15 minutes)

### Test 1: Basic Functionality
- [ ] Plugin loads without errors
- [ ] DOOM process starts (PID shown in console)
- [ ] Socket connection established
- [ ] Input handler starts
- [ ] PCB traces render

### Test 2: Gameplay
- [ ] Movement (WASD) works
- [ ] Turning (Arrow keys) works
- [ ] Shooting (Ctrl) works
- [ ] Opening doors (Space/E) works
- [ ] Weapon switching (1-7) works

### Test 3: Performance
- [ ] FPS reported in console (target: 10-25 FPS)
- [ ] No "Slow frame" warnings (or very few)
- [ ] No memory leaks (check Activity Monitor)

### Test 4: Stability
- [ ] Run for 5 minutes without crash
- [ ] Quit and restart plugin 3 times
- [ ] No crashes during any session

### Test 5: Cleanup
- [ ] Plugin cleanup messages appear
- [ ] DOOM process terminates
- [ ] Socket file removed (`/tmp/kicad_doom.sock`)
- [ ] PCB board returns to normal state

## Console Output Reference

### Successful Startup
```
======================================================================
======================================================================
     DOOM ON PCB - KiCad Plugin
======================================================================
======================================================================

Board: blank_project.kicad_pcb

======================================================================
Configuring Board for Performance
======================================================================
‚úì Set to 2-layer board
‚úì Enabled minimal layers
‚úì Cleared highlighting

======================================================================
Creating Renderer
======================================================================

======================================================================
Initializing DOOM PCB Renderer
======================================================================
Creating shared DOOM net...
‚úì Created net: DOOM_WORLD

Creating object pools...
‚úì Renderer initialized
======================================================================

======================================================================
Creating Communication Bridge
======================================================================

======================================================================
Starting DOOM Bridge Socket Server
======================================================================
‚úì Socket created: /tmp/kicad_doom.sock
  Timeout: 10.0s

Waiting for DOOM to connect...
(Make sure doomgeneric_kicad is running)

======================================================================
Launching DOOM
======================================================================
Binary: /Users/tribune/Desktop/KiDoom/doom/doomgeneric_kicad
Working directory: /Users/tribune/Desktop/KiDoom/doom
‚úì DOOM process started (PID: 12345)
‚úì DOOM connected!
‚úì Receive loop started in background thread
‚úì Input handler started

======================================================================
======================================================================
     DOOM IS RUNNING!
======================================================================
======================================================================

Controls:
  WASD          - Move (forward/back/strafe)
  Arrow keys    - Turn left/right
  Ctrl          - Fire weapon
  Space / E     - Use / Open doors
  1-7           - Select weapon
  Esc           - Menu / Quit

The DOOM window should appear shortly.
Watch the PCB editor - traces will animate!

Press ESC in DOOM to quit when done.
======================================================================
```

### Successful Shutdown
```
DOOM exited with code: 0

======================================================================
Cleaning Up
======================================================================
‚úì Input handler stopped
‚úì Bridge stopped
‚úì DOOM process terminated
Cleaning up renderer...
‚úì Renderer cleaned up

======================================================================
Session Summary
======================================================================

Renderer Statistics:
  Frames rendered: 1543
  Average FPS: 18.2
  Total runtime: 84.8s

Bridge Statistics:
  Frames received: 1543
  Receive errors: 0

======================================================================
DOOM on PCB - Session Complete
======================================================================
```

## Troubleshooting

### KiCad Still Crashes
1. **Check Python wx module**:
   ```python
   import wx
   print(wx.VERSION_STRING)
   ```
   Should print version (e.g., "4.2.0")

2. **Verify changes applied**:
   ```bash
   grep -n "wx.CallAfter" ~/Desktop/KiDoom/kicad_doom_plugin/pcb_renderer.py
   ```
   Should show lines 151 and 472

3. **Check KiCad version**:
   - Help ‚Üí About KiCad
   - Requires KiCad 7+ (tested on 9.0.2)

### No PCB Traces Visible
1. **Check View settings**:
   - View ‚Üí Show Grid: OFF
   - View ‚Üí Ratsnest: OFF
   - Zoom out to see full board

2. **Check layer visibility**:
   - Layers panel should show F.Cu and B.Cu enabled

### DOOM Window Doesn't Appear
1. **Check DOOM stderr**:
   - Look for errors in console after "DOOM process started"
   - Common: WAD file not found

2. **Verify DOOM binary**:
   ```bash
   file ~/Desktop/KiDoom/doom/doomgeneric_kicad
   ```
   Should show: "Mach-O 64-bit executable arm64"

### Performance Issues (< 5 FPS)
1. **Check Manual Settings** (from console output):
   - View ‚Üí Show Grid: OFF
   - View ‚Üí Ratsnest: OFF
   - Preferences ‚Üí Graphics ‚Üí Antialiasing: Fast
   - Preferences ‚Üí Graphics ‚Üí Rendering: Accelerated

2. **Check Activity Monitor**:
   - KiCad CPU usage should be 50-100%
   - Memory usage should be < 500 MB

## Reporting Issues

If crash persists, collect:
1. **Console output** (full startup through crash)
2. **Crash report** (~/Library/Logs/DiagnosticReports/)
3. **System info**:
   - macOS version (About This Mac)
   - KiCad version (Help ‚Üí About)
   - Hardware (M1/M2/Intel, RAM)

Submit to: https://github.com/anthropics/claude-code/issues

## Success! What Next?

If tests pass:
1. **Play the full first level** (E1M1)
2. **Try different WAD files** (Doom II, custom WADs)
3. **Record video** for demonstration
4. **Share on social media** (#KiDoom #KiCad #DOOM)

Enjoy running DOOM on your PCB! üéÆ
