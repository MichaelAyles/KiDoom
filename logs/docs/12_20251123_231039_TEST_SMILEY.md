# Test Smiley Face Plugin

This simple test verifies that timer-based PCB rendering works on macOS without crashes.

## What It Does

- Draws an animated rotating smiley face using PCB traces
- Uses same timer architecture as DOOM plugin
- **No background threads** - all operations on main thread
- If this works: timer approach is valid
- If this crashes: fundamental issue with KiCad on macOS

## Test Procedure

### 1. Quit KiCad
```bash
# Make sure KiCad is completely closed
killall kicad
```

### 2. Set Test Mode
```bash
# Enable test mode for the plugin
export KIDOOM_TEST_MODE=true
```

### 3. Launch KiCad
```bash
# Launch from same terminal to inherit the environment variable
open -a KiCad
```

### 4. Open a PCB
- File → New Project → Blank PCB
- Or: Open `kicad_source/blank_project/blank_project.kicad_pcb`

### 5. Run Test Plugin
- Tools → External Plugins → **"KiDoom - DOOM on PCB"**
- Since KIDOOM_TEST_MODE=true, it will run the smiley test instead of DOOM

### 6. Expected Behavior

**Console output:**
```
======================================================================
SMILEY FACE TEST - Timer-Based Rendering
======================================================================
✓ Created 68 traces for smiley face
Starting timer...
✓ Timer started (20 FPS)

======================================================================
Smiley face is animating!
Watch the PCB editor for a rotating smiley face.
Close this dialog to stop the animation.
======================================================================

Frame 20, angle 100°
Frame 40, angle 200°
Frame 60, angle 300°
...
```

**PCB editor:**
- Should see a smiley face appear
- Face should **rotate** continuously
- Eyes and mouth should move with face
- No crashes, no freezes

### 7. Stop Test
- Click **OK** on the dialog
- Smiley should disappear
- Console should show:
  ```
  Stopping animation...
  ✓ Timer stopped
  Cleaning up traces...
  ✓ Cleanup complete
  ✓ Test complete
  ```

## Success Criteria

✅ Plugin runs without crash
✅ Smiley face appears on PCB
✅ Face rotates smoothly
✅ No KiCad freezing
✅ Clean shutdown when closing dialog

## Failure Scenarios

### Crash on Launch
**Symptom**: KiCad crashes immediately when clicking plugin
**Meaning**: Even simple timer setup crashes on macOS
**Indicates**: Fundamental incompatibility with KiCad plugin system

### No Rendering
**Symptom**: Dialog appears but no smiley face visible
**Possible causes**:
- Timer not starting
- Zoom level too high (zoom out to see full board)
- Traces on wrong layer (enable F.Cu and B.Cu visibility)

### Crash During Animation
**Symptom**: KiCad crashes after a few frames
**Meaning**: Timer callback crashes when modifying PCB objects
**Indicates**: Same issue as DOOM plugin - can't modify PCB from timer

### Face Appears but Doesn't Rotate
**Symptom**: Static smiley face, no animation
**Possible causes**:
- Timer not firing (check console for "Frame N" messages)
- Refresh not being called
- Update logic broken

## Debug Mode

To see detailed timing:

```python
# In test_smiley_plugin.py, add to _on_timer():

print(f"Thread: {threading.current_thread().name}")
print(f"Main thread: {threading.current_thread() == threading.main_thread()}")
```

Should show:
```
Thread: MainThread
Main thread: True
```

## What This Tests

### Verified If Successful

1. ✅ wx.Timer works in KiCad plugins
2. ✅ Timer callbacks run on main thread
3. ✅ Can modify PCB objects from timer
4. ✅ pcbnew.Refresh() works from timer
5. ✅ No threading issues with this approach

### Does NOT Test

- ❌ Background thread communication (not used)
- ❌ Queue-based updates (not used)
- ❌ High frame rate stress (only 20 FPS)
- ❌ Complex object pools (simple trace list)

## Next Steps

### If Test PASSES

**Good news!** The timer approach works. Problem with DOOM plugin is:
- Background thread still doing something wrong
- Queue implementation has bug
- Something specific to DOOM bridge

**Action**: Debug DOOM plugin's queue/thread interaction

### If Test FAILS

**Bad news!** Even simple timer crashes. Issues could be:
- KiCad 9.0.2 has plugin bugs on macOS
- wx.Timer not compatible with KiCad's event loop
- PCB modifications not allowed from plugins at all on macOS

**Action**:
1. Try on different KiCad version
2. Try on Linux/Windows to confirm it's macOS-specific
3. Report bug to KiCad project

## Comparison to DOOM Plugin

### Smiley (Simple)
- One thread (main)
- Direct timer → update → refresh
- No queue
- No background processing

### DOOM (Complex)
- Two threads (main + background)
- Background → queue → timer → update → refresh
- Queue communication
- Background socket processing

**If smiley works but DOOM doesn't**: Issue is in multi-threading, not timer itself.

## Manual Inspection

While smiley is running:

1. **Activity Monitor**:
   - Find "kicad" process
   - CPU should be 5-15%
   - Memory stable

2. **Console app** (macOS):
   - Filter for "kicad"
   - Look for any error messages

3. **PCB Editor**:
   - View → Show Grid (OFF for better visibility)
   - Zoom to fit (View → Zoom to Fit)
   - Should see smooth rotation

## Cleanup

If plugin crashes and leaves traces behind:

1. Close KiCad
2. Reopen board
3. Edit → Undo repeatedly
4. Or: Reload board file without saving

## Expected Results

On working system:
- Test completes successfully
- Smooth 20 FPS animation
- No errors in console
- Clean shutdown

This confirms the architecture is sound and we can proceed with debugging the DOOM plugin's specific threading issues.
