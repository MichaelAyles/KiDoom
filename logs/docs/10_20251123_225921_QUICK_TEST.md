# Quick Test - Timer-Based Threading Fix

## Pre-Test Checklist

1. âœ… Quit KiCad completely (Cmd+Q)
2. âœ… Verify DOOM binary exists:
   ```bash
   ls -lh ~/Desktop/KiDoom/doom/doomgeneric_kicad
   ```
3. âœ… Check WAD file:
   ```bash
   ls -lh ~/Desktop/KiDoom/doom/doom1.wad
   ```

## Test Steps (2 minutes)

### 1. Launch and Load
```bash
# Start KiCad
open -a KiCad

# Wait for it to fully load, then:
# File â†’ Open Project â†’ Desktop/KiDoom/kicad_source/blank_project/blank_project.kicad_pro
```

### 2. Run Plugin
- Tools â†’ External Plugins â†’ "KiDoom - DOOM on PCB"
- **Watch console for**:
  ```
  ======================================================================
  Starting Refresh Timer
  ======================================================================
  âœ“ Started refresh timer (30.3 FPS max)
  ```

### 3. Verify No Crash
- **Expected**: DOOM window appears
- **Expected**: No KiCad crash
- **Expected**: Console shows "DOOM process started (PID: ...)"

### 4. Check Rendering
- Wait ~10 seconds for DOOM to fully load
- Press **Enter** to start game
- **Look at PCB editor window**
- **Expected**: Red/cyan traces appearing and animating
- Move with WASD
- **Expected**: Traces move as you move

### 5. Quick Play Test
- Play for **30 seconds**
- Move around, turn, shoot (Ctrl)
- **Expected**: Smooth animation, no crashes, 10-25 FPS

### 6. Clean Exit
- Press **ESC** twice to quit DOOM
- **Expected**: DOOM closes, console shows:
  ```
  âœ“ Stopped refresh timer
  Cleaning up renderer...
  ```

## Success Criteria

âœ… No crash when launching plugin
âœ… Timer starts (console message)
âœ… DOOM launches
âœ… PCB traces render and animate
âœ… Smooth performance (10-25 FPS)
âœ… Clean shutdown

## If It Still Crashes...

### Collect Debug Info

1. **Check exact crash location**:
   - Did it crash during:
     - Plugin launch? (Before timer starts)
     - DOOM connection? (After timer starts)
     - First frame? (During gameplay)
     - Shutdown? (After quitting DOOM)

2. **Check console output**:
   - Did timer start successfully?
   - Any Python exceptions?
   - Any "ERROR" or "WARNING" messages?

3. **Get crash report**:
   ```bash
   open ~/Library/Logs/DiagnosticReports/
   # Find latest kicad crash report
   ```

### Common Issues

**Timer not starting**:
```
WARNING: Failed to start refresh timer
```
- **Cause**: wx event loop not running
- **Fix**: Ensure KiCad is fully loaded before running plugin

**No rendering**:
- **Check**: View â†’ Show Grid (should be OFF)
- **Check**: View â†’ Ratsnest (should be OFF)
- **Try**: Zoom out to see full board

**Still crashes on Refresh**:
- **Possible**: Timer somehow not on main thread
- **Debug**: Add print to `_on_refresh_timer()`:
  ```python
  print(f"Timer on main thread: {threading.current_thread() == threading.main_thread()}")
  ```

## Success? Next Steps

If the test passes:

1. **Play longer** (5 minutes)
2. **Test multiple sessions** (quit and restart 3 times)
3. **Try different settings** (higher resolution, more enemies)
4. **Record video** of PCB animation
5. **Share results** on GitHub/social media

## Debug Mode

To see detailed timing info, edit `config.py`:

```python
DEBUG_MODE = True
LOG_FRAME_TIMES = True
```

This will show:
- Timer events
- Refresh timing
- Frame statistics
- Any internal errors

## Performance Tuning

If FPS is too low (< 10 FPS):

### Option 1: Reduce Refresh Rate
```python
# In doom_plugin_action.py, change:
renderer.start_refresh_timer(interval_ms=50)  # 20 FPS instead of 30
```

### Option 2: Check KiCad Settings
- Preferences â†’ Graphics:
  - Rendering: Accelerated
  - Antialiasing: Fast or Disabled
- View:
  - Grid: OFF
  - Ratsnest: OFF

### Option 3: Simplify Level
- Use E1M1 (first level) - fewer objects
- Avoid rooms with many enemies

## Reporting Results

If successful, please share:
- macOS version
- KiCad version
- Hardware (M1/M2/Intel, RAM)
- Achieved FPS
- Any issues encountered

If failed, please provide:
- All of the above
- Console output (full)
- Crash report
- Exact steps to reproduce

Thank you for testing! ðŸš€
